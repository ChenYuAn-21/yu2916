<div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
    <h2 style="margin:0">{{ item.name }} â€” å•ç­”å€</h2>
    <div style="margin-left:auto">
        <a href="{{ url_for('index') }}" style="padding:6px 10px;background:#2196F3;color:#fff;border-radius:6px;text-decoration:none;margin-right:8px">ğŸ  å›é¦–é </a>
        <a href="{{ url_for('item_detail', item_id=item.id) }}" style="padding:6px 10px;background:#777;color:#fff;border-radius:6px;text-decoration:none">ğŸ”™ æŸ¥çœ‹å•†å“</a>
    </div>
</div>
<div id="qa-root" data-item-id="{{ item.id }}"></div>

<div id="messages" style="border:1px solid #ccc;height:300px;overflow-y:scroll;padding:10px;">
{% for m in messages %}
<div>
    <b>
        {{ m.display_name }}{% if m.user_id %} (ID: {{ m.user_id }}){% endif %}
        {# å¦‚æœæ²’æœ‰ user_idï¼ˆåŒ¿åï¼‰ï¼Œä¸é¡¯ç¤ºè§’è‰²æ¨™ç±¤ï¼›è‹¥æœ‰ user_idï¼Œå°å·²è¨»å†Šçš„ä½¿ç”¨è€…é¡¯ç¤ºå°æ‡‰è§’è‰²æ¨™ç±¤(è³£å®¶æˆ–æ¶ˆè²»è€…)ï¼Œä½†è‹¥ display_name å·²åŒ…å«è§’è‰²è©ä¹Ÿç•¥é #}
        {% if m.user_id %}
            {% set role_label = 'è³£å®¶' if m.sender == 'seller' else 'æ¶ˆè²»è€…' %}
            {% if role_label not in (m.display_name or '') %}
                <span class="role-badge {% if m.sender == 'seller' %}seller{% else %}buyer{% endif %}">{{ role_label }}</span>
            {% endif %}
        {% endif %}
        :
    </b>
    {{ m.msg }}
    <small style="color:#666">{% if m.timestamp %}{{ m.timestamp | gmt8 }}{% endif %}</small>
</div>
{% endfor %}
</div>

<input id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯">
<div style="margin-bottom:8px;">
    {% if session.get('user_id') %}
        <b>ç›®å‰ä½¿ç”¨è€…ï¼š</b> {{ session.get('user_name') }} (ID: {{ session.get('user_id') }})
        {% if session.get('user_id')|int == item.seller_id|default(0)|int %}
            <span style="color:green; margin-left:8px;">ï¼ˆæ­¤ä½¿ç”¨è€…ç‚ºè³£å®¶ï¼‰</span>
        {% endif %}
    {% else %}
        <b>ç›®å‰ä½¿ç”¨è€…ï¼š</b> åŒ¿åï¼ˆç³»çµ±å°‡è‡ªå‹•ä»¥ã€ŒåŒ¿åæ¶ˆè²»è€…ã€èº«åˆ†ç•™è¨€ï¼‰
    {% endif %}
</div>
<button onclick="sendMessage()">é€å‡º</button>

{% raw %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const root = document.getElementById('qa-root');
const itemId = root ? root.dataset.itemId : null;
const room = 'item_' + itemId;

socket.emit('join', { room: room });

socket.on('message', function(data) {
    const box = document.getElementById('messages');
    const row = document.createElement('div');
    const bold = document.createElement('b');
    const display = data.display_name ? data.display_name : (data.sender ? (data.sender === 'seller' ? 'è³£å®¶' : 'åŒ¿åæ¶ˆè²»è€…') : 'ä½¿ç”¨è€…');
    // åç¨±èˆ‡ ID
    bold.appendChild(document.createTextNode(display + (data.user_id ? (' (ID: ' + data.user_id + ')') : '')));
    // åªæœ‰ç•¶ message æœ‰ user_id æ™‚ï¼ˆä»£è¡¨æ­¤è¨Šæ¯ä¾†è‡ªå·²è¨»å†Šçš„ä½¿ç”¨è€…ï¼‰æ‰é¡¯ç¤ºè§’è‰²æ¨™ç±¤ï¼›åŒ¿åè¨Šæ¯ä¸é¡¯ç¤ºæ¨™ç±¤
    if (data.user_id) {
        const roleLabel = data.sender === 'seller' ? 'è³£å®¶' : 'æ¶ˆè²»è€…';
        if (!display.includes(roleLabel)) {
            const roleSpan = document.createElement('span');
            roleSpan.textContent = roleLabel;
            roleSpan.className = 'role-badge ' + (data.sender === 'seller' ? 'seller' : 'buyer');
            bold.appendChild(roleSpan);
        }
    }
    bold.appendChild(document.createTextNode(':'));
    row.appendChild(bold);
    row.appendChild(document.createTextNode(' ' + data.msg));
    box.appendChild(row);
    box.scrollTop = box.scrollHeight;
});

function sendMessage() {
    var msg = document.getElementById('messageInput').value;
    if (msg.trim() === '') return;
    socket.emit('send_message', { room: room, msg: msg, item_id: itemId });
    document.getElementById('messageInput').value = '';
}
// æ”¯æ´æŒ‰ Enter é€å‡ºï¼ˆShift+Enter å¯æ›è¡Œï¼‰
document.getElementById('messageInput').addEventListener('keydown', function(e){
    if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
    }
});
</script>
{% endraw %}
