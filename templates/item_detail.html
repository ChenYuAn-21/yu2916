{% extends 'base.html' %}

{% block content %}
<div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
    <h2 style="margin:0">{{ item.name }}</h2>
    <div style="margin-left:auto; display:flex; align-items:center; gap:8px">
        <a href="{{ url_for('index') }}" style="padding:6px 10px;background:#2196F3;color:#fff;border-radius:6px;text-decoration:none;margin-right:8px">ğŸ  å›é¦–é </a>
        <a href="{{ url_for('qa', item_id=item.id) }}" style="padding:6px 10px;background:#777;color:#fff;border-radius:6px;text-decoration:none">ğŸ’¬ å•ç­”å€</a>
        {% if session.get('user_id') and seller and session.get('user_id')|int == seller.id|int %}
            <!-- è³£å®¶ï¼šé¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•ï¼ˆæ”¾åœ¨æ¨™é¡Œå³å´ï¼‰ -->
            <a href="{{ url_for('edit_item', item_id=item.id) }}" style="padding:6px 10px;background:#4CAF50;color:white;border-radius:6px;text-decoration:none;margin-left:6px">âœï¸ ç·¨è¼¯ç‰©å“</a>
        {% elif seller and session.get('user_id') and session.get('user_id')|int != seller.id|int %}
            <!-- è²·å®¶ï¼šé¡¯ç¤ºè¯çµ¡è³£å®¶æŒ‰éˆ•ï¼ˆæ”¾åœ¨ç›¸åŒä½ç½®ï¼‰ -->
            <a href="{{ url_for('conversations_start', seller_id=seller.id, item_id=item.id) }}" style="padding:6px 10px;background:#607D8B;color:#fff;border-radius:6px;text-decoration:none;margin-left:6px">âœ‰ï¸ è¯çµ¡è³£å®¶</a>
        {% endif %}
    </div>
</div>

{% if item.image_path %}
    <img src="{{ url_for('uploaded_file', filename=item.image_path) }}" width="300"><br>
{% else %}
    <div style="width:300px; height:220px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#888;">æœªæœ‰åœ–ç‰‡</div>
{% endif %}
<p>åˆ†é¡ï¼š{{ item.category }}</p>
<p>ç‹€æ³ï¼š{{ item.condition }}</p>
<p>åƒ¹æ ¼ï¼š{% if item.price %}{{ item.price|int }} å…ƒ{% else %}æ´½è©¢{% endif %}</p>
<p>æ ¡å€ï¼š{{ item.campus }}</p>
<p>åº«å­˜æ•¸é‡ï¼š{{ item.quantity or 0 }} {% if item.is_active is not none and not item.is_active %}<strong style="color:#d32f2f;">ï¼ˆå·²ä¸‹æ¶ï¼‰</strong>{% endif %}</p>
<p>å·²åŠ å…¥è³¼ç‰©è»Šäººæ•¸ï¼š<strong>{{ carts_count or 0 }}</strong>ï¼ˆåŠ å…¥è³¼ç‰©è»Šä¸ä¿ç•™åº«å­˜ï¼Œåƒ…ä¾›å…ˆæ¶å…ˆè´åƒè€ƒï¼‰</p>
{% if seller %}
<p>è³£å®¶ï¼š{{ seller.name }} (ID: {{ seller.id }})</p>
{% else %}
<p>è³£å®¶ï¼šæœªæŒ‡å®š</p>
{% endif %}

{% if item.notes %}
<div class="item-notes">
    <div class="item-notes-header">ğŸ“Œ å‚™è¨»èªªæ˜</div>
    <div class="item-notes-body" style="white-space:pre-wrap">{{ item.notes }}</div>
</div>
{% endif %}

<div class="item-delivery">
    <h3>å–è²¨ / å¯„é€èˆ‡ä»˜æ¬¾æ–¹å¼</h3>
    <ul>
        {% if pickup_methods and pickup_methods|length > 0 %}
            {% for p in pickup_methods %}
                <li>å–è²¨æ–¹å¼ï¼š{{ p }}</li>
            {% endfor %}
        {% else %}
            <li>å–è²¨æ–¹å¼ï¼šæœªæŒ‡å®š</li>
        {% endif %}

        {% if item.shipping_type %}
            <li>å¯„é€æ–¹å¼ï¼š{{ item.shipping_type }}{% if item.shipping_type == 'é‹è²»å¤–åŠ ' and item.shipping_fee %}ï¼ˆé‹è²» {{ item.shipping_fee|int }} å…ƒï¼‰{% endif %}</li>
        {% endif %}

        {% if payment_methods and payment_methods|length > 0 %}
            <li>ä»˜æ¬¾æ–¹å¼ï¼š{{ payment_methods|join(', ') }}</li>
        {% else %}
            <li>ä»˜æ¬¾æ–¹å¼ï¼šé¢äº¤æ”¶ç¾</li>
        {% endif %}
    </ul>
</div>

{# edit button moved to header for consistent placement (# see header area) #}
{% if not (session.get('user_id') and seller and session.get('user_id')|int == seller.id|int) %}
    <hr>
    {% if session.get('user_id') %}
    {% set need_shipping = (item.shipping_type) or ('å¯„é€' in pickup_methods) %}
    <div class="purchase-actions">
        {% if form_error %}
        <div style="padding:8px;background:#ffe6e6;border:1px solid #f5c2c2;color:#a94442;margin-bottom:8px;">{{ form_error }}</div>
        {% endif %}
        <!-- å·²ç™»å…¥æœƒå“¡ï¼šé¡¯ç¤ºåŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ• -->
        <form method="post" action="{{ url_for('add_to_cart', item_id=item.id) }}" style="display:inline-block; margin-right:12px;">
            <input type="hidden" name="qty" value="1">
            <div style="margin-top:8px">
                <button type="submit" style="padding:8px 12px;background:#2196F3;color:#fff;border-radius:6px;border:none;" {% if item.quantity is not none and item.quantity <= 0 %}disabled{% endif %}>â• åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </form>

        <!-- å·²ç™»å…¥æœƒå“¡ï¼šç«‹å³è³¼è²·è¡¨å–® -->
        <form method="post" action="{{ url_for('buy_now', item_id=item.id) }}" style="display:inline-block;">
            <input type="hidden" name="qty" value="1">
            <div style="margin-top:8px">
                <label>å§“æ°ï¼ˆå¿…å¡«ï¼‰ï¼š <input type="text" name="contact_lastname" required></label>
            </div>
            <div style="margin-top:6px">
                <label>èº«åˆ†ï¼š
                    <select name="contact_role">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="åŒå­¸">åŒå­¸</option>
                        <option value="æ•™è·å“¡">æ•™è·å“¡</option>
                    </select>
                </label>
            </div>
            <div style="margin-top:6px">
                <label>è¯çµ¡æ‰‹æ©Ÿï¼ˆå¿…å¡«ï¼‰ï¼š <input type="tel" name="contact_phone" required></label>
            </div>
            <div style="margin-top:6px">
                <label>å–è²¨æ–¹å¼ï¼š
                    <label><input type="radio" name="delivery_method" value="pickup" checked> é¢äº¤</label>
                    <label><input type="radio" name="delivery_method" value="shipping"> å¯„é€</label>
                </label>
            </div>
            {% if need_shipping %}
            <div id="buyShippingAddress" style="margin-top:6px; display:none;">
                <label>å¯„é€åœ°å€ï¼ˆé¸æ“‡å¯„é€æ™‚å¿…å¡«ï¼‰ï¼š<br><input type="text" name="shipping_address" style="width:300px"></label>
            </div>
            {% endif %}
            <div style="margin-top:8px">
                <button type="submit" style="padding:8px 12px;background:#FF5722;color:#fff;border-radius:6px;border:none;" {% if item.quantity is not none and item.quantity <= 0 %}disabled{% endif %}>ğŸ’³ ç«‹å³è³¼è²·</button>
            </div>
        </form>
        <script>
            (function(){
                var radios = document.getElementsByName('delivery_method');
                function update(){
                    var val = null;
                    for(var i=0;i<radios.length;i++){ if(radios[i].checked) val = radios[i].value; }
                    var box = document.getElementById('buyShippingAddress');
                    if(box) box.style.display = (val === 'shipping') ? 'block' : 'none';
                }
                for(var i=0;i<radios.length;i++){ radios[i].addEventListener('change', update); }
                update();
            })();
        </script>
    </div>
    {% else %}
    <div style="padding:10px;background:#f4f4f4;border-radius:6px;">
        <strong>è³¼è²·/åŠ å…¥è³¼ç‰©è»Šç‚ºæœƒå“¡é™å®šåŠŸèƒ½</strong><br>
        è«‹å…ˆ <a href="{{ url_for('login') }}">ç™»å…¥</a> æˆ– <a href="{{ url_for('register') }}">è¨»å†Š</a> å¾Œå†è³¼è²·æˆ–åŠ å…¥è³¼ç‰©è»Šã€‚
    </div>
    {% endif %}
{% endif %}

{% endblock %}
